<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <base href="/" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Complaint Inbox</title>
  <link rel="stylesheet" href="complaint_inbox.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
</head>
<body>
  <div class="navbar d-flex justify-content-between align-items-center px-4 py-2">
    <div class="d-flex align-items-center">
      <img src="rinl-logo.png" alt="VIZAG Steel Logo" height="80" class="me-3" />
      <div>
        <h4 class="m-0">Rashtriya Ispat Nigam Limited</h4>
        <h5 class="text-success m-0">Visakhapatnam Steel Plant</h5>
        <small>(A Govt. of India Enterprise)</small>
      </div>
    </div>
    <div class="d-flex">
      <img src="rinl-logo2.jpg" alt="Beti Bachao" height="80" class="me-3" />
      <img src="rinl-logo3.jpg" alt="Yoga" height="80" />
    </div>
  </div>

  <section class="maintenance-schedule-section py-5">
    <div class="container bg-white rounded shadow p-4">
      <h3 class="fw-bold mb-1">Complaint Inbox</h3>
      <p class="text-muted mb-4">Preventive maintenance tasks and their statuses.</p>
      <div class="table-responsive">
        <table class="table table-borderless align-middle text-center schedule-table">
          <thead class="text-muted small">
            <tr>
              <th>ID</th>
              <th><i class="fa-solid fa-computer"></i> Asset</th>
              <th><i class="fa-solid fa-building"></i> Department</th>
              <th>Scheduled Date</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- Complaint rows will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Modal for Complaint Details -->
  <div class="modal fade" id="complaintModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Complaint Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body"></div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" />

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const tableBody = document.querySelector("tbody");
      const modalBody = document.querySelector("#complaintModal .modal-body");

      // Fetch session info
      const sessionRes = await fetch('/etl/user/session');
      const sessionData = await sessionRes.json();
      const emp_id = sessionData.emp_id;

      // Fetch complaints
      const res = await fetch(`/etl/user/${emp_id}/home/complaint/inbox`);
      const complaints = await res.json();

      tableBody.innerHTML = "";

      complaints.forEach(complaint => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><a href="#" class="open-complaint text-decoration-none" data-id="${complaint.complaint_id}">${complaint.complaint_id}</a></td>
          <td>${complaint.asset_number}</td>
          <td>${complaint.department}</td>
          <td>${new Date(complaint.date).toLocaleDateString()}</td>
          <td>
            <span class="badge ${complaint.Status === 'Completed' ? 'bg-success' : 'bg-warning-subtle text-warning'}">
              <i class="fa-solid fa-ellipsis-h"></i> ${complaint.Status}
            </span>
          </td>
          <td style="min-width: 60px">
            <div class="dropdown">
              <button class="btn btn-link text-muted p-0" type="button" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-h"></i>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#">Accept</a></li>
                <li><a class="dropdown-item text-success" href="#">Completed</a></li>
              </ul>
            </div>
          </td>
        `;
        tableBody.appendChild(tr);

        // Show modal with complaint details
        tr.querySelector(".open-complaint").addEventListener("click", (e) => {
          e.preventDefault();
          const c = complaint;
          modalBody.innerHTML = `
            <h5 class="mb-3 text-primary">Complaint ID: ${c.complaint_id}</h5>
            <p><strong>Asset Number:</strong> ${c.asset_number}</p>
            <p><strong>BOQ Item ID:</strong> ${c.boq_item_id}</p>
            <p><strong>Date:</strong> ${new Date(c.date).toLocaleString()}</p>
            <p><strong>Mobile No:</strong> ${c.mobile_no}</p>
            <p><strong>Category:</strong> ${c.category}</p>
            <p><strong>Department:</strong> ${c.department}</p>
            <p><strong>Description:</strong> ${c.description}</p>
            <p><strong>Location:</strong> ${c.location}</p>
            <p><strong>Ratings:</strong> ${c.ratings}</p>
            <p><strong>Zone:</strong> ${c.zone}</p>
            <p><strong>Status:</strong> ${c.Status}</p>
          `;
          const modal = new bootstrap.Modal(document.getElementById("complaintModal"));
          modal.show();
        });
      });
    });
  </script>
</body>
</html>
